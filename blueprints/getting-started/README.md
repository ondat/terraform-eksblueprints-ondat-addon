# Ondat

## Introduction

Ondat is a cloud native, software-defined storage for running containerized
applications in production, running in the cloud, on-prem and in
hybrid/multi-cloud environments. Ondat is free for personal use and offers
licenses for commercial usage. More information is available in
the [Ondat documentation](https://docs.ondat.io/docs/introduction/).

This module uses [ebs-bootstrap](https://github.com/ondat/etcd3-bootstrap)
and it's associated Terraform module to provision persistent storage via
EBS underneath EKS worker nodes in managed node groups.
[etcd3-terraform](https://github.com/ondat/etcd3-terraform) provides an
etcd cluster dedicated to Ondat.

The following is a high-level overview of the components generated by this module:

- 1x VPC with private and public subnets, internet gateway etc.
- 1x EKS cluster with 3 single-node managed node groups
- 1x etcd cluster with 3 single-node ASGs and an NLB
- 3x EBS volumes for the 3 etcd nodes with daily automatic snapshots and 1 week retention
- 6x EBS volumes for the 3 EKS nodes with daily automatic snapshots and 1 week retention
- Installation of Ondat via Helm on the EKS cluster

## Installation

### Prerequisites

Make sure to have the following components installed on your local system:

- [aws-cli](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)
- [kubectl](https://kubernetes.io/docs/tasks/tools/)
- [terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli)

### Process

1. First, clone the repository:

```shell
git clone https://github.com/ondat/terraform-eksblueprints-ondat-addon.git
```

1. Initialise the Terraform module:

```shell
cd blueprints/getting-started
terraform init
```

1. Make any necessary adjustments to the `main.tf` file - eg. for the best level
of performance, it's certainly worth adjusting instance sizes and disk types and
provisioned IOPS for higher performance (at higher cost).
1. Use Terraform to plan a deployment:

```shell
export AWS_REGION=us-east-1
export AWS_PROFILE=<YOUR_PROFILE>
export KUBE_CONFIG_FILE=~/.kube/config
terraform plan
```

1. Apply the deployment with Terraform - note that you may need to first apply the
IAM policy for data nodes as other resources depend on it:

```shell
terraform apply -target=aws_iam_policy.data
terraform apply
```

1. The process may fail to connect to Kubernetes when it's time to deploy Ondat,
use the AWS CLI to provision a kubeconfig profile for the cluster:

```shell
terraform output # This command will output the command below
aws eks --region $AWS_REGION update-kubeconfig --name $CLUSTER_NAME
terraform apply
```

1. Check that the nodes have created and that Ondat is running:

```shell
kubectl get nodes
```

You should see 3 nodes in the list.

```shell
kubectl get pods -n storageos
```

You should see a `storageos-node` pod running on each node.

### Uninstall

1. To uninstall, destroy with Terraform - note that this will **delete all data**.

```shell
terraform destroy
```

## Operations

### Licensing

By default, an unlicensed Ondat cluster will allow for 50GB of
provisioned capacity. To download and install a free, personal
license for 3 nodes and 1TiB of provisioned capacity or an 
unrestricted trial license,
[follow the instructions in Ondat's documentation](https://docs.ondat.io/docs/operations/licensing/#ondat-cli---running-the-cli).

### Self-evaluation

We provide a guided tour of Ondat's capabilities with some helpful benchmarking
scripts via our [self-evaluation guide](https://docs.ondat.io/docs/self-eval/#deploy-the-ondat-cli-as-a-container).

## Appendix

### Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.0.1 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 3.66.0 |
| <a name="requirement_helm"></a> [helm](#requirement\_helm) | >= 2.4.1 |
| <a name="requirement_kubernetes"></a> [kubernetes](#requirement\_kubernetes) | >= 2.6.1 |

### Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | 4.0.0 |

### Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_terraform-aws-eks-blueprints"></a> [terraform-aws-eks-blueprints](#module\_terraform-aws-eks-blueprints) | github.com/aws-ia/terraform-aws-eks-blueprints | n/a |
| <a name="module_aws_vpc"></a> [aws\_vpc](#module\_aws\_vpc) | terraform-aws-modules/vpc/aws | v3.2.0 |
| <a name="module_etcd"></a> [etcd](#module\_etcd) | github.com/ondat/etcd3-terraform | n/a |
| <a name="module_kubernetes-addons"></a> [kubernetes-addons](#module\_kubernetes-addons) | github.com/aws-ia/terraform-aws-eks-blueprints//modules/kubernetes-addons | n/a |
| <a name="module_persist-ebs"></a> [persist-ebs](#module\_persist-ebs) | github.com/ondat/etcd3-bootstrap/terraform/modules/attached_ebs | n/a |

### Resources

| Name | Type |
|------|------|
| [aws_iam_policy.data](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_ami.ami](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) | data source |
| [aws_availability_zones.available](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/availability_zones) | data source |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_eks_cluster.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/eks_cluster) | data source |
| [aws_eks_cluster_auth.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/eks_cluster_auth) | data source |
| [aws_partition.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/partition) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |
| [aws_subnet.one](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet) | data source |
| [aws_subnet.three](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet) | data source |
| [aws_subnet.two](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet) | data source |

### Inputs

No inputs.

### Outputs

No outputs.
